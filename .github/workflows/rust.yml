name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        run: |
          rustup toolchain install nightly --component rust-src
          rustup default nightly

      - name: Install QEMU & llvm
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 llvm

      - name: Build kernel
        run: cargo build --release -Z build-std=core,compiler_builtins --target src/arch/x86_64/x86_64-unknown-none.json

      - name: Build 16-bit boot sector
        run: clang -m16 -c src/arch/x86_64/bootsector.S -o target/x86_64-unknown-none/release/bootsector.o

      - name: Link boot sector flat binary
        run: ld -m elf_i386 -Ttext 0x7C00 --oformat binary target/x86_64-unknown-none/release/bootsector.o -o target/x86_64-unknown-none/release/bootsector.bin

      - name: Stitch floppy image
        run: |
          chmod +x src/arch/x86_64/post-link.sh
          src/arch/x86_64/post-link.sh target/x86_64-unknown-none/release lex-kernel

      - name: Run in QEMU (boot sector â†’ kernel)
        run: timeout 3s qemu-system-x86_64 -fda target/x86_64-unknown-none/release/floppy.img -nographic || [ $? -eq 124 ]
